Prior posts from this mini-series:

* Thanos Shauntlet: [https://www.reddit.com/r/PowerShell/comments/199i7nr/now\_presenting\_the\_thanos\_shauntlet/](https://www.reddit.com/r/PowerShell/comments/199i7nr/now_presenting_the_thanos_shauntlet/)
* Turning PowerShell Into A Python Engine: [https://www.reddit.com/r/PowerShell/comments/192uavr/turning\_powershell\_into\_a\_python\_engine/](https://www.reddit.com/r/PowerShell/comments/192uavr/turning_powershell_into_a_python_engine/)
* Turning PowerShell Into A JavaScript Engine: [https://www.reddit.com/r/PowerShell/comments/1937hkv/turning\_powershell\_into\_a\_javascript\_engine/](https://www.reddit.com/r/PowerShell/comments/1937hkv/turning_powershell_into_a_javascript_engine/)
* Working On Turning PowerShell Into A Node.JS Engine: [https://www.reddit.com/r/PowerShell/comments/1djdql5/working_on_turning_powershell_into_a_nodejs_engine/](https://www.reddit.com/r/PowerShell/comments/1djdql5/working_on_turning_powershell_into_a_nodejs_engine/)
  * **TL;DR: [_Github gist_](https://gist.github.com/anonhostpi/7ebc4007f3f51e0f255c2408d33b1781)**

# TL;DR:

```powershell
git clone https://github.com/anonhostpi/njs-cjs-pwsh
cd njs-cjs-pwsh
cd pwsh
. .\main.v2.ps1

# $setup
# $paths

# $runtime
# $engine

# $tests
```

# Week 2: More on the importance of `internalBinding()`

OK, I finally have a good grasp on Node's binding system.

The more and more I dig into node.JS's internals, the more I am convinced that I only need to replicate a few Node APIs (bindings), then I can port _all of the internal nodeJS modules_ without much effort.

There are only a few exceptions to this rule. Most of the bound APIs (including the exceptions) are partially laid out in the node_builtins.cc file. The rest are laid out in each binding loaded by `internalBinding()` provided by the node_binding.cc file.

Both of these API types provide their own unique module type. Both sets can be parsed with the `process.moduleLoadList` array. The `moduleLoadList` array is a list of both `Internal Binding` modules loaded via `internalBinding()` and `NativeModule` (they are actually called `BuiltinModules`, but for legacy support they are listed as `NativeModules`) modules loaded via `compileForInternalLoader()` in the order they are loaded.

## node_builtins.cc and NativeModules/BuiltinModules

The node_builtins.cc binary is responsible for loading the _internal_ `NativeModule`/`BuiltinModule` JS files from node's C++ land with certain objects added as arguments.

There are 3 functions of importance in node_builtins.cc:
- `LookupAndCompile()` which wraps provided JS files in a function with a specified set of arguments. These arguments often include variables like `require`, `internalBinding`, and `primordials`.
- `CompileAndCall()` which calls the function returned by `LookupAndCompile()`. It is called by the main process.
- `CompileFunction()` which can be called from JS land to compile an internal js module using `LookupAndCompile()`.

### `LookupAndCompile()` and js2c.cc (formerly known as js2c.py)

`LookupAndCompile()` is a function that looksup an internal module and builds an associated callback/wrapper function with the contents of that module to be used by JS land's `compileFunction()` and C++ land's `CompileAndCall()`. `LookupAndCompile()` internally calls `BuiltinLoader::LoadBuiltinSource()` which parses the `BuiltinLoader::source_` source code map generated by the js2c.cc binary. 

js2c.cc is a utility for converting JavaScript source code into C-style char arrays. Think of it as creating a hashtable of filename keys paired to their source code as a string. The output of js2c.cc is a C++ file that is used to embed these modules into the node binary.
  - At compile time, the compiled js2c binary is fed the contents of lib/internal (I think it also maps the rest of lib/, but node's build files can be hard to follow) and outputs to a node_javascript.cc file to be compiled into the node binary.

## node_binding.cc and Internal Bindings

The node_binding.cc binary is responsible for providing the C++ backend to `internalBinding()`. `internalBinding()` is mapped to this C++ backend by node_builtins.cc and the lib/internal/bootstrap/realm.js files. Specifically, node_binding.cc provides a `GetInternalBinding()` function that is used by realm.js to generate `internalBinding()`, which is then fed back to node_builtins.cc via `setInternalLoaders()` to be used for the rest of the modules loaded via `LookupAndCompile()`.

Confusing, right? Here's an overview:

- _node_binding.cc_ sets `GetInternalBinding()` 
- _node_builtins.cc_ provides `GetInternalBinding()` to realm.js
- _realm.js_ defines `internalBinding()` using `GetInternalBinding()` 
- _realm.js_ sends `internalBinding()` to node_builtins.cc via `setInternalLoaders()` 
- _node_builtins.cc_ uses the new `internalBinding()` for the rest of the modules loaded via `LookupAndCompile()`
  - which is called by `CompileAndCall()` (C++ land) and `CompileFunction()` (JS land).

### `GetInternalBinding()` and `NODE_BINDING_CONTEXT_AWARE_INTERNAL()`

What `GetInternalBinding()` actually returns is an internal C++ NAPI module marked with the `NM_F_INTERNAL` flag. This flag is set by the `NODE_BINDING_CONTEXT_AWARE_INTERNAL()` macro that typically occurs at the end of that NAPI module's source code. The syntax of `NODE_BINDING_CONTEXT_AWARE_INTERNAL()` is as follows:

```c++
NODE_BINDING_CONTEXT_AWARE_INTERNAL(module_name, reg_func)
```

We're going to ignore the `reg_func` argument. To be honest it goes over my head. There are a few other macros that are used in conjunction with `NODE_BINDING_CONTEXT_AWARE_INTERNAL()` to expose specific APIs, but I currently don't have my head wrapped around them, just yet.

For now, I'm going to just generate a list of all instances of `NODE_BINDING_CONTEXT_AWARE_INTERNAL()` and list out what APIs are exposed by each by hand. I will generate a PowerShell script to search the node source repository for those instances, but other than that, the following list was generated by hand:

#### All Internal Bindings in Node.JS:

# Week 2: More on the importance of `internalBinding()`



The more and more I dig into node.js's internals, the more I am convinced that if I only need to replicate a few Node APIs, the I can port _all of the internal nodejs modules_ without much effort. These APIs are exposed to JS via

```powershell
$callFrameTest = @{}
$tests.dumper.dump.Source.GetEnumerator() | ForEach-Object {
    $scriptId = $_.Key
    $source = $_.Value.source
    $metadata = $_.Value.metadata
    $url = $metadata.url
    $callFrames = $metadata.stackTrace.callFrames
    $fnName = $callFrames[0].functionName
    
    If( $callFrameTest["$fnName ($($callFrames[0].url):$($callFrames[0].lineNumber))"].Count -eq 0 ){
        $callFrameTest["$fnName ($($callFrames[0].url):$($callFrames[0].lineNumber))"] = @{}
    }
    $callFrameTest["$fnName ($($callFrames[0].url):$($callFrames[0].lineNumber))"][$url] = $_.Value
}
```

There are a few other instances of node/C++ APIs being exposed to JS other than `internalBinding()`, but they are few. One of the few, but important ones is `compileFunction()` which is wrapped by realm.js's `BuiltinModule.compileForInternalLoader()`.

# TODOS:
- cover:
    - `node::RunBootstrapping` and `node::LoadEnvironment` in node.cc
    - realm.js's unique bindings, and how they are loaded from node.cc:
        - https://github.com/nodejs/node/blob/dcebac8885762c9e37a1a197bab847c8ee4d0bcc/lib/internal/bootstrap/realm.js#L11
        - https://github.com/nodejs/node/blob/dcebac8885762c9e37a1a197bab847c8ee4d0bcc/src/node.cc#L237
            - `ExecuteBootstrapper()` which calls:
                - https://github.com/nodejs/node/blob/dcebac8885762c9e37a1a197bab847c8ee4d0bcc/src/node_realm.cc#L161
                    - `BuiltinLoader::CompileAndCall()`
    - `require("module").builtinModules` generated by js2c binary
        - js2c is a utility for converting JavaScript source code into C-style char arrays. It is used for embedded JavaScript code in the V8 library.
            - https://stackoverflow.com/a/25113732/10534510
    - `realpathSync()` and the definition of `require` being in helpers.js
        - https://github.com/nodejs/node/blob/2e5fc8aa1aaf18bdee227dfc03380e9e60dd0cd5/lib/internal/modules/helpers.js#L115
    - process.moduleLoadList
        - list of both `Internal Binding` modules loaded via `internalBinding()` and `NativeModule` modules loaded via `compileForInternalLoader()`
    - [ ] a good `internalBinding()` analyzer - goes hand in hand with `NODE_BINDING_CONTEXT_AWARE_INTERNAL()`
        - presence of `NODE_BINDING_CONTEXT_AWARE_INTERNAL()` indicates compatibility with `internalBinding()`
            - it marks the module as `NM_F_INTERNAL`, and sends it `node_module_register()`. `node_module_register()` then chains the module together with the rest of the modules in modlist_internal.
                - the same happens for linked (`NM_F_LINKED`) modules, but they are chained together in modlist_linked.
                    - as far as I know there is no C++ macro for linked modules, but there is a js function to call said bindings: `process._linkedBinding()`
                    - this API adds bindings to the node source code at the time it is compiled for the purpose of embedding the node engine into another application, and doing so with additional userland APIs.
    - [ ] cover tracing.
    - [ ] `NODE_BINDING_CONTEXT_AWARE_INTERNAL()` and `NODE_BINDING_EXTERNAL_REFERENCE()`
        - context aware internal marks a module as being compatible with `internalBinding()`
        - external reference defines the APIs to be exposed by the C++ module
    - [ ] node_binding.cc
        - https://github.com/nodejs/node/blob/d4a40fd1f77e4a3a7dff3b4cf654ce8557198846/src/node_binding.cc#L261-L276
    - [ ] node_builtins.cc
        - https://github.com/nodejs/node/blob/d4a40fd1f77e4a3a7dff3b4cf654ce8557198846/src/node_builtins.cc#L376-L426
            - `LookupAndCompile()`
                - builds the callback/wrapper function to be used by `compileFunction()`
                - in C++ land, `BuiltinLoader::CompileFunction()` wraps `BuiltinLoader::LookupAndCompile()`
        - https://github.com/nodejs/node/blob/dcebac8885762c9e37a1a197bab847c8ee4d0bcc/src/node_builtins.cc#L428-L473
            - `CompileAndCall()`
    